# SiYuan CLI 架构设计

## 项目概述

SiYuan CLI 是一个用于操作思源笔记（SiYuan Note）的命令行工具，基于 TypeScript/Node.js 开发，支持笔记本管理、文档操作、块级操作、SQL 查询等功能。

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           用户层 (User Layer)                       │
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Terminal    │  │  Web UI      │  │  IM 机器人    │          │
│  │  (命令行)    │  │  (浏览器)     │  │  (OpenClaw)  │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
└─────────┼───────────────────┼───────────────────┼────────────────────┘
          │                   │                   │
          └───────────────────┴───────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        CLI 层 (CLI Layer)                          │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐         │
│  │                    src/cli/index.ts                   │         │
│  │              (Commander.js 路由)                       │         │
│  └────────┬───────────────┬───────────────┬───────────┘         │
│           │               │               │                          │
│   ┌───────▼───────┐ ┌───▼────────┐ ┌─▼──────────────┐       │
│   │  NotebookCmd  │ │  DocCmd    │ │  BlockCmd     │       │
│   └───────────────┘ └────────────┘ └───────────────┘       │
│           │               │               │                          │
│           └───────────────┴───────────────┘                          │
│                           │                                       │
└───────────────────────────┼───────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        API 层 (API Layer)                          │
│                                                                   │
│   ┌────────────────────────────────────────────────────┐           │
│   │              src/api/client.ts                  │           │
│   │            (SiYuanClient 基类)                │           │
│   └──────────────┬────────────────────────────────┘            │
│                  │                                             │
│   ┌──────────────┼──────────────┬──────────────┐          │
│   │              │              │              │          │
│ ┌─▼────────┐ ┌──▼────────┐ ┌──▼────────┐ ┌──▼──────┐ │
│ │ notebook │ │ document  │ │  block     │ │ search   │ │
│ └──────────┘ └───────────┘ └────────────┘ └─────────┘ │
└───────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        HTTP 层 (HTTP Layer)                        │
│                                                                   │
│   ┌────────────────────────────────────────────┐                  │
│   │              Axios HTTP 客户端           │                  │
│   └──────────────┬─────────────────────────┘                  │
│                  │                                           │
└───────────────────┼───────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                   思源笔记 API (SiYuan API)                      │
│                                                                   │
│   ┌────────────────────────────────────────────┐                  │
│   │         http://127.0.0.1:6806        │                  │
│   └────────────────────────────────────────────┘                  │
│                                                                   │
│   端点:                                                           │
│   - /api/notebook/*      (笔记本操作)                              │
│   - /api/filetree/*      (文档操作)                                │
│   - /api/block/*         (块操作)                                  │
│   - /api/query/sql       (SQL 查询)                                │
└───────────────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                   思源笔记数据层 (Data Layer)                       │
│                                                                   │
│   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│   │ Notebooks │  │ Documents │  │  Blocks   │  │ Attributes│   │
│   └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└───────────────────────────────────────────────────────────────────────────┘
```

## 模块说明

### 1. CLI 层 (`src/cli/`)

命令行接口层，负责：
- 解析命令行参数
- 路由到对应的命令处理
- 处理全局选项

**文件结构：**
```
src/cli/
├── index.ts          # CLI 入口，配置 Commander.js
└── commands/         # 命令定义
    ├── notebook.ts    # 笔记本命令组
    ├── doc.ts        # 文档命令组
    ├── block.ts      # 块命令组
    ├── search.ts     # 搜索命令
    └── config.ts    # 配置命令组
```

### 2. API 层 (`src/api/`)

API 客户端层，负责：
- 封装思源笔记 HTTP API 调用
- 处理认证
- 错误处理

**文件结构：**
```
src/api/
├── client.ts         # SiYuanClient 基类，提供 post() 方法
├── notebook.ts       # 笔记本 API
├── document.ts       # 文档 API
├── block.ts         # 块 API
├── search.ts        # SQL 查询 API
└── index.ts         # 导出所有 API 函数
```

### 3. 配置层 (`src/config/`)

配置管理模块，负责：
- 加载配置（文件、环境变量、命令行参数）
- 配置合并和优先级处理
- 配置验证

**配置优先级：**
```
命令行参数 > 环境变量 > 配置文件 > 默认值
```

**环境变量：**
- `SIYUAN_ENDPOINT` - API 端点
- `SIYUAN_TOKEN` - API Token
- `SIYUAN_TIMEOUT` - 请求超时
- `SIYUAN_OUTPUT_FORMAT` - 输出格式

### 4. 工具层 (`src/utils/`)

通用工具模块，负责：
- 日志记录
- 输出格式化（table/json/markdown）
- 辅助函数

**文件结构：**
```
src/utils/
├── index.ts         # 导出所有工具函数
├── logger.ts        # 日志记录
└── formatter.ts     # 输出格式化
```

### 5. 类型层 (`src/types/`)

TypeScript 类型定义，负责：
- 定义 API 响应类型
- 定义配置类型
- 定义请求/响应数据结构

## 数据流

### 请求流程

```
用户输入 → CLI 解析 → 命令处理 → API 调用 → HTTP 请求 → 思源 API
    ↓         ↓           ↓          ↓           ↓           ↓
配置加载 → 参数验证 → 数据转换 → Token 添加 → 错误处理 → 响应返回
    ↓                                                               ↓
格式化输出 ← 错误处理 ← 响应解析 ← 响应数据 ← 思源数据
```

### 示例：创建文档

```
1. 用户执行: siyuan doc create "笔记" "Inbox/测试"
2. CLI 解析: 识别 doc create 命令
3. 配置加载: 从文件/环境/默认值加载配置
4. API 调用: createDoc(client, request)
5. HTTP 请求: POST /api/filetree/createDocWithMd
6. 思源处理: 创建文档，返回文档 ID
7. 响应解析: 提取文档 ID
8. 格式化输出: 显示成功消息
```

## 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| CLI | Commander.js | 命令行参数解析和路由 |
| HTTP | Axios | HTTP 客户端 |
| 配置 | cosmiconfig | 多格式配置文件支持 |
| 输出 | cli-table3 | 表格格式化 |
| 输出 | chalk | 彩色终端输出 |
| 语言 | TypeScript | 类型安全 |
| 运行时 | Node.js | JavaScript 运行时 |

## 安全考虑

1. **API Token**: 存储在配置文件中，不在日志中显示
2. **HTTPS**: 支持加密通信（通过 endpoint 配置）
3. **认证**: 所有 API 请求携带 Token
4. **验证**: 配置验证确保必要字段存在

## 扩展性

1. **新增命令**: 在 `src/cli/commands/` 中添加新命令类
2. **新增 API**: 在 `src/api/` 中添加新的 API 函数
3. **新增格式化器**: 在 `src/utils/formatter.ts` 中添加新的格式化函数
